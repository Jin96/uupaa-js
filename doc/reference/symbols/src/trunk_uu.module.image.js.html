<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.linenumber {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='linenumber'>  1</span> <span class="COMM">/** &lt;b>Image Module&lt;/b>
<span class='linenumber'>  2</span>  *
<span class='linenumber'>  3</span>  * @author Takao Obara
<span class='linenumber'>  4</span>  * @license uupaa.js is licensed under the terms and conditions of the MIT licence.
<span class='linenumber'>  5</span>  */</span><span class="WHIT">
<span class='linenumber'>  6</span> </span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">uud</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uuw</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uu</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uuw.uu</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>  7</span> 
<span class='linenumber'>  8</span> </span><span class="NAME">uu.module.image</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>  9</span> 
<span class='linenumber'> 10</span> </span><span class="COMM">/** &lt;b>Image&lt;/b>
<span class='linenumber'> 11</span>  *
<span class='linenumber'> 12</span>  * @class
<span class='linenumber'> 13</span>  */</span><span class="WHIT">
<span class='linenumber'> 14</span> </span><span class="NAME">uu.image</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 15</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 16</span> 
<span class='linenumber'> 17</span> </span><span class="COMM">/** &lt;b>画像のロード済み確認 - Is image loaded&lt;/b>
<span class='linenumber'> 18</span>  *
<span class='linenumber'> 19</span>  * 画像をロード済み(すぐに使用可能な状態)ならtrueを返します。
<span class='linenumber'> 20</span>  *
<span class='linenumber'> 21</span>  * @param String url - 画像のURLを指定します。絶対URLを指定します。
<span class='linenumber'> 22</span>  * @return Boolean   - ロード済みでtrueを返します。
<span class='linenumber'> 23</span>  */</span><span class="WHIT">
<span class='linenumber'> 24</span> </span><span class="NAME">uu.image.isLoaded</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">url</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 25</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">judge</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">node.complete</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">node.src</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'> 26</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">uu.toArray</span><span class="PUNC">(</span><span class="NAME">uud.images</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">some</span><span class="PUNC">(</span><span class="NAME">judge</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 27</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 28</span> 
<span class='linenumber'> 29</span> </span><span class="COMM">/** &lt;b>画像のプリロード - Preload image&lt;/b>
<span class='linenumber'> 30</span>  *
<span class='linenumber'> 31</span>  * 画像を非同期にロードします。
<span class='linenumber'> 32</span>  * リクエスト終了でfn(code, url, image要素)をコールします。&lt;br />
<span class='linenumber'> 33</span>  * codeには成功で1,失敗で0が格納されます。&lt;br />
<span class='linenumber'> 34</span>  *
<span class='linenumber'> 35</span>  * このメソッドはロールオーバーやcanvasで使用する画像のプリロード用です。&lt;br />&lt;br />
<span class='linenumber'> 36</span>  *
<span class='linenumber'> 37</span>  * 既に画像が使用可能になっている状態(uu.image.isLoaded()==true)で呼ばれた場合は、
<span class='linenumber'> 38</span>  * 即座に関数を実行します。
<span class='linenumber'> 39</span>  *
<span class='linenumber'> 40</span>  * @param String   url - 画像のパスの指定です。絶対URLや相対パスを指定します。
<span class='linenumber'> 41</span>  * @param Function fn  - リクエスト終了で呼び出す関数を指定します。デフォルトはuu.muteです。
<span class='linenumber'> 42</span>  * @see &lt;a href="#timeout">uu.image.timeout&lt;/a> - タイムアウト時間の指定
<span class='linenumber'> 43</span>  * @see &lt;a href="#delay">uu.image.delay&lt;/a> - 遅延時間の指定
<span class='linenumber'> 44</span>  * @see &lt;a href="http://d.hatena.ne.jp/uupaa/20080413/1208067631">uupaa開発日記&lt;/a>
<span class='linenumber'> 45</span>  */</span><span class="WHIT">
<span class='linenumber'> 46</span> </span><span class="NAME">uu.image.preload</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="WHIT"> </span><span class="COMM">/* = uu.mute */</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// for Firefox3, Safari3.1, Opera9.5β3, IE6/7/8β</span><span class="WHIT">
<span class='linenumber'> 47</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tick</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">img</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">run</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// 二重起動防止用</span><span class="WHIT">
<span class='linenumber'> 48</span> 
<span class='linenumber'> 49</span> </span><span class="COMM">//url = url.toAbsURL();</span><span class="WHIT">
<span class='linenumber'> 50</span> </span><span class="WHIT">  </span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uu.url.abs</span><span class="PUNC">(</span><span class="NAME">url</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 51</span> </span><span class="WHIT">  </span><span class="NAME">fn</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">uu.mute</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 52</span> </span><span class="WHIT">  </span><span class="NAME">img</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Image</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 53</span> 
<span class='linenumber'> 54</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">uu.image.isLoaded</span><span class="PUNC">(</span><span class="NAME">url</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// already loaded</span><span class="WHIT">
<span class='linenumber'> 55</span> </span><span class="WHIT">    </span><span class="NAME">img.src</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 56</span> </span><span class="WHIT">    </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">img</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 57</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 58</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'> 59</span> </span><span class="WHIT">  </span><span class="NAME">img.onabort</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">img.onerror</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">run</span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">img</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 60</span> </span><span class="WHIT">  </span><span class="NAME">img.onload</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 61</span> </span><span class="WHIT">    </span><span class="NAME">run</span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">uu.ua.opera</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">img.complete</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">img</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">img</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 62</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 63</span> </span><span class="WHIT">  </span><span class="NAME">img.src</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 64</span> 
<span class='linenumber'> 65</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">run</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uu.image.timeout</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 66</span> </span><span class="WHIT">    </span><span class="NAME">uuw.setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 67</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">run</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'> 68</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">uu.ua.gecko</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">img.complete</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">img.width</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="COMM">// Firefox2は読込失敗でcomplete=true, width=0になる</span><span class="WHIT">
<span class='linenumber'> 69</span> </span><span class="WHIT">          </span><span class="PUNC">(</span><span class="NAME">tick</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uu.image.delay</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">uu.image.timeout</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// タイムアウト</span><span class="WHIT">
<span class='linenumber'> 70</span> </span><span class="WHIT">        </span><span class="NAME">run</span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">img</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 71</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 72</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'> 73</span> </span><span class="WHIT">      </span><span class="NAME">uuw.setTimeout</span><span class="PUNC">(</span><span class="NAME">arguments.callee</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uu.image.delay</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 74</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 75</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'> 76</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 77</span> 
<span class='linenumber'> 78</span> </span><span class="COMM">/** &lt;b>24bitのαチャネルを処理する - 24bit alpha channel png image&lt;/b>
<span class='linenumber'> 79</span>  *
<span class='linenumber'> 80</span>  * png画像を動的に追加し、透過させたい場合に、この関数をコールします。&lt;br />
<span class='linenumber'> 81</span>  * IE5.5/6.0以外のブラウザでは何もしません。
<span class='linenumber'> 82</span>  *
<span class='linenumber'> 83</span>  * @param Element/Array elm - 要素または、要素の配列を指定します。
<span class='linenumber'> 84</span>  * @param Boolean [force]   - 既に透過済みの画像を再度透過させる場合にtrueを指定します。デフォルトはfalseです。
<span class='linenumber'> 85</span>  */</span><span class="WHIT">
<span class='linenumber'> 86</span> </span><span class="NAME">uu.image.png24</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">elm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">force</span><span class="WHIT"> </span><span class="COMM">/* = false */</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 87</span> </span><span class="NAME">uu.image.png24._file</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uu.config.imagePath</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"uu.module.image.1x1.gif"</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// png24で使用する1x1のgifイメージのファイル名</span><span class="WHIT">
<span class='linenumber'> 88</span> </span><span class="NAME">uu.image.png24._search</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'> 89</span> 
<span class='linenumber'> 90</span> </span><span class="COMM">/** &lt;b>タイムアウト時間 - Timeout&lt;/b>
<span class='linenumber'> 91</span>  * uu.image.load()で使用するタイムアウト時間を指定します。
<span class='linenumber'> 92</span>  * 1以上の数値を指定します。単位はmsです。
<span class='linenumber'> 93</span>  * デフォルトは10000です。
<span class='linenumber'> 94</span>  *
<span class='linenumber'> 95</span>  * @type number
<span class='linenumber'> 96</span>  * @see &lt;a href="#preload">uu.image.preload()&lt;/a> - 画像のプリロード
<span class='linenumber'> 97</span>  */</span><span class="WHIT">
<span class='linenumber'> 98</span> </span><span class="NAME">uu.image.timeout</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">10000</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// 10000ms(10s)</span><span class="WHIT">
<span class='linenumber'> 99</span> 
<span class='linenumber'>100</span> </span><span class="COMM">/** &lt;b>遅延時間 - Delay&lt;/b>
<span class='linenumber'>101</span>  * uu.image.load()で使用する遅延時間の指定です。
<span class='linenumber'>102</span>  * 10以上の数値を指定します。単位はmsです。デフォルトは50です。
<span class='linenumber'>103</span>  *
<span class='linenumber'>104</span>  * @type number
<span class='linenumber'>105</span>  * @see &lt;a href="#preload">uu.image.preload()&lt;/a> - 画像のプリロード
<span class='linenumber'>106</span>  */</span><span class="WHIT">
<span class='linenumber'>107</span> </span><span class="NAME">uu.image.delay</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">50</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// 50ms</span><span class="WHIT">
<span class='linenumber'>108</span> 
<span class='linenumber'>109</span> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">uu.config.png24</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uu.ua.ie</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">uu.ua.version</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">5</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uu.ua.version</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">7</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// 5.5 or 6.0</span><span class="WHIT">
<span class='linenumber'>110</span> </span><span class="WHIT">  </span><span class="COMM">// uu.mixで、元のuu.image.png24()のプロパティ(_file,_search等)を引き継いだuu.image.png24()を作り出す</span><span class="WHIT">
<span class='linenumber'>111</span> </span><span class="WHIT">  </span><span class="COMM">// 普通に上書きすると、_file,_searchはundefinedになってしまうが、</span><span class="WHIT">
<span class='linenumber'>112</span> </span><span class="WHIT">  </span><span class="COMM">// このようにすると、子孫との関係を維持しつつ、親(この場合function)の中身の入れ替えが可能になる。</span><span class="WHIT">
<span class='linenumber'>113</span> </span><span class="WHIT">  </span><span class="NAME">uu.image.png24</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uu.mix</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">elm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">force</span><span class="WHIT"> </span><span class="COMM">/* = false */</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>114</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">w</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">h</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>115</span> </span><span class="WHIT">    </span><span class="PUNC">(</span><span class="NAME">uu.isA</span><span class="PUNC">(</span><span class="NAME">elm</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">elm</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">elm</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">v</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>116</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">force</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">v.uu_png24</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>117</span> </span><span class="WHIT">      </span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">v.width</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">h</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">v.height</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>118</span> </span><span class="WHIT">      </span><span class="NAME">v.style.filter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">v.src</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'",sizingMethod=image)'</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>119</span> </span><span class="WHIT">      </span><span class="NAME">uu.mix</span><span class="PUNC">(</span><span class="NAME">v</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">src</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">uu.image.png24._file</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">width</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">w</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">height</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">h</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uu_png24</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>120</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>121</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uu.image.png24</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>122</span> 
<span class='linenumber'>123</span> </span><span class="WHIT">  </span><span class="COMM">/** &lt;b>24bit化するpng画像を列挙&lt;/b>
<span class='linenumber'>124</span>    *
<span class='linenumber'>125</span>    * 条件に一致するpng画像を列挙し配列を返します。&lt;br />
<span class='linenumber'>126</span>    *    条件1. ".png"拡張子(大/小文字は無視)&lt;br />
<span class='linenumber'>127</span>    *    条件2. alt,srcの文字列の一部が"24b"または"24B"か、classに"alpha"が含まれている&lt;br />
<span class='linenumber'>128</span>    *
<span class='linenumber'>129</span>    * @return Array    img要素の配列を返します。要素が見つからない場合は[]を返します。
<span class='linenumber'>130</span>    * @private
<span class='linenumber'>131</span>    */</span><span class="WHIT">
<span class='linenumber'>132</span> </span><span class="WHIT">  </span><span class="NAME">uu.image.png24._search</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>133</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rv</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>134</span> </span><span class="WHIT">    </span><span class="NAME">uu.toArray</span><span class="PUNC">(</span><span class="NAME">uud.images</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">v</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>135</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">v.complete</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="REGX">/.png$/i</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">v.src</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>136</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">v.alt</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="REGX">/24b/i</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">v.alt</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="REGX">/24b/i</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">v.src</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">uu.klass.has</span><span class="PUNC">(</span><span class="NAME">v</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"alpha"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>137</span> </span><span class="WHIT">          </span><span class="NAME">rv.push</span><span class="PUNC">(</span><span class="NAME">v</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>138</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>139</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>140</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>141</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">rv</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>142</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>143</span> 
<span class='linenumber'>144</span> </span><span class="WHIT">  </span><span class="COMM">// 画像のプリロードに成功したら透過処理を行う。</span><span class="WHIT">
<span class='linenumber'>145</span> </span><span class="WHIT">  </span><span class="COMM">// 読込失敗で何もしない(デバッグモードなら例外を挙げる)</span><span class="WHIT">
<span class='linenumber'>146</span> </span><span class="WHIT">  </span><span class="NAME">uu.window.ready</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>147</span> </span><span class="WHIT">    </span><span class="NAME">uu.image.preload</span><span class="PUNC">(</span><span class="NAME">uu.image.png24._file</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">code</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>148</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">code</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>149</span> </span><span class="WHIT">        </span><span class="NAME">code</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">uu.image.png24</span><span class="PUNC">(</span><span class="NAME">uu.image.png24._search</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>150</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">uu.config.debug</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>151</span> </span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"image not exist: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">uu.image.png24._file</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>152</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>153</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>154</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='linenumber'>155</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>156</span> 
<span class='linenumber'>157</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// end (function())()</span><span class="WHIT">
<span class='linenumber'>158</span> </span></pre></body></html>